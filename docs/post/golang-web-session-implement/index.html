<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="https://www.ibyte.me/static/img/author.png" type="image/gif" />
    <meta name="theme-color" content="dark">
    <title>Golang Web Session Implement | æ‰“ç åŒ </title>

    
    
    
    <meta property="og:site_name" content="æ‰“ç åŒ  | ibyte.me" />
    <meta property="og:title" content="Golang Web Session Implement | æ‰“ç åŒ "/>
    <meta itemprop="name" content="Golang Web Session Implement | æ‰“ç åŒ " />
    <meta name="twitter:title" content="Golang Web Session Implement | æ‰“ç åŒ " />
    <meta name="application-name" content="Golang Web Session Implement | æ‰“ç åŒ " />


    <meta name="description" content="Share computer science and technology, Golang, Rust, distributed systems, system design articles." />
    <meta name="twitter:description" content="Share computer science and technology, Golang, Rust, distributed systems, system design articles."/>
    <meta itemprop="description" content="Share computer science and technology, Golang, Rust, distributed systems, system design articles."/>
    <meta property="og:description" content="Share computer science and technology, Golang, Rust, distributed systems, system design articles." />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Leon Ding" />
<meta property="og:article:published_time" content=2021-09-16T22:41:38&#43;0800 />
<meta property="article:published_time" content=2021-09-16T22:41:38&#43;0800 />





<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Golang Web Session Implement",
    "author": {
      "@type": "Person",
      "name": "Leon Ding"
    },
    "datePublished": "2021-09-16",
    "description": "",
    "wordCount":  1409 ,
    "mainEntityOfPage": "True",
    "dateModified": "2021-09-16",
    "publisher": {
      "@type": "Organization",
      "name": "Leon Ding",
      "logo": {
        "@type": "imageObject",
        "url": "http:\/\/blog.ibyte.me\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.85d2dd3a54e29956009c7c48e5f5d4bc22b6af329dc58a4fc8919e8c12720daa.css">
    
</head>
    <script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    
                    æ‰“ç åŒ 
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button">
                  <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                  <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                </button>
            </div>
            </div>
    </div>
</nav>
        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>Golang Web Session Implement</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                              
                            
                            By Leon Ding | <time>September 16, 2021</time>
                            | 7 minutes
                        </div>
                        <div class="tags">
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <h2 id="æ¦‚-è¿°">
    <a href="#%e6%a6%82-%e8%bf%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    æ¦‚ è¿°
</h2>
<p>å¤§å®¶éƒ½çŸ¥é“ <code>session</code> æ˜¯<code>webåº”ç”¨</code>åœ¨æœåŠ¡å™¨ç«¯å®ç°çš„ä¸€ç§ç”¨æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´è®¤è¯çš„è§£å†³æ–¹æ¡ˆï¼Œç›®å‰ <code>Go</code> æ ‡å‡†åŒ…æ²¡æœ‰ä¸º <code>session</code> æä¾›ä»»ä½•æ”¯æŒï¼Œæœ¬æ–‡æˆ‘å°†è®²è§£<code>session</code>çš„å®ç°åŸç†ï¼Œå’Œä¸€äº›å¸¸è§åŸºäº<code>session</code>å®‰å…¨äº§ç”Ÿçš„é˜²å¾¡é—®é¢˜ã€‚</p>
<p>å½“ç„¶æœ‰äººå¯èƒ½çœ‹äº†ä¼šæŠ¬æ ï¼Œè¯´ç°åœ¨å¤§éƒ¨åˆ†ä¸æ˜¯å‰åç«¯åˆ†ç¦»æ¶æ„å—ï¼Ÿå¯¹ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>JWT</code>è§£å†³ä½ çš„é—®é¢˜ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ä¸€ä½“åŒ–<code>web</code>åº”ç”¨éœ€è¦<code>session</code>ï¼Œæ‰€ä»¥æˆ‘å‡†å¤‡é€ ä¸ªè½®å­ã€‚è‡ªå·±é€ çš„è½®å­å“ªé‡Œå‡ºé—®é¢˜äº†ï¼Œæ¯”åˆ«äººæ›´ç†Ÿæ‚‰ï¼Œæœ‰<code>bug</code>äº†ï¼Œè¿˜ä¸ç”¨æ±‚ç€åˆ«äººä¿®<code>bug</code>,è‡ªå·±ä¿®å°±å¥½äº†ï¼Œå‘µå‘µå“ˆå“ˆå“ˆï¼Œå½“ç„¶è¿™å‡ å¥è¯æœ‰ç‚¹çš®ğŸ˜œã€‚</p>
<p><img loading="lazy" 
    src="https://tva1.sinaimg.cn/large/008eGmZEgy1goyrvcs0n1j307q04zaa0.jpg" 
    alt="å˜¤ å˜¤ å˜¤&amp;hellip;" 
     /></p>
<h2 id="éœ€-æ±‚">
    <a href="#%e9%9c%80-%e6%b1%82" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    éœ€ æ±‚
</h2>
<p>æˆ‘è§‰å¾—ä¸€åå¥½çš„ç¨‹åºå‘˜ï¼Œåœ¨å†™ç¨‹åºä¹‹å‰åº”è¯¥åˆ—ä¸€ä¸‹éœ€æ±‚åˆ†æï¼Œæ•´ç†ä¸€ä¸‹æ€è·¯ï¼Œç„¶åå†å»å†™ä»£ç ã€‚</p>
<ul>
<li>æ”¯æŒå†…å­˜å­˜å‚¨ä¼šè¯æ•°æ®</li>
<li>æ”¯æŒåˆ†å¸ƒå¼<code>redis</code>ä¼šè¯å­˜å‚¨</li>
<li>ä¼šè¯å¦‚æœæœ‰å¿ƒè·³å°±è‡ªåŠ¨ç»­å‘½<code>30</code>åˆ†é’Ÿï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰</li>
<li>æä¾›é˜²å¾¡ï¼š<code>ä¸­é—´äºº</code>ï¼Œ<code>ä¼šè¯åŠ«æŒ</code>ï¼Œ<code>ä¼šè¯é‡æ”¾</code>ç­‰æ”»å‡»</li>
</ul>
<h2 id="å·¥ä½œåŸç†">
    <a href="#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    å·¥ä½œåŸç†
</h2>
<p>é¦–å…ˆå¿…é¡»äº†è§£å·¥ä½œåŸç†æ‰èƒ½å†™ä»£ç ï¼Œè¿™é‡Œæˆ‘å°±ç¨å¾®è¯´ä¸€ä¸‹ï¼Œ<code>session</code>æ˜¯åŸºäº<code>cookie</code>å®ç°çš„ï¼Œä¸€ä¸ª<code>session</code>å¯¹åº”ä¸€ä¸ª<code>uuid</code>ä¹Ÿæ˜¯<code>sessionid</code>ï¼Œåœ¨æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œç„¶åæŠŠè¿™ä¸ª<code>sessionid</code>é€šè¿‡<code>cookie</code>è®©æµè§ˆå™¨ä¿å­˜ç€ï¼Œä¸‹æ¬¡æµè§ˆå™¨è¯·æ±‚è¿‡æ¥äº†å°±ä¼šæœ‰<code>sessionid</code>ï¼Œç„¶åé€šè¿‡<code>sessionid</code>è·å–è¿™ä¸ªä¼šè¯çš„æ•°æ®ã€‚</p>
<p><img loading="lazy" 
    src="https://tva1.sinaimg.cn/large/008eGmZEgy1goyr6owhr0j30gw0c23z5.jpg" 
    alt="è¯·æ±‚è¿‡ç¨‹" 
     /></p>
<h2 id="ä»£ç å®ç°">
    <a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    ä»£ç å®ç°
</h2>
<p>éƒ½æ˜¯è¯´ç€å®¹æ˜“ï¼Œå®é™…å†™èµ·æ¥å°±æ˜¯å„ç§å‘ï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯å®ç°äº†ã€‚</p>
<p><img loading="lazy" 
    src="https://tva1.sinaimg.cn/large/008eGmZEgy1goyrnh2ebmj30dc07j3yk.jpg" 
    alt="linus ğŸ–•" 
     /></p>
<p><strong>å°‘è¯´åºŸè¯ï¼Œè¿˜æ˜¯ç›´æ¥å¹²ä»£ç å§ã€‚</strong></p>
<ol>
<li>ä¾èµ–å…³ç³»</li>
</ol>
<p><img loading="lazy" 
    src="https://tva1.sinaimg.cn/large/008eGmZEgy1goysgg2puij30hz0dz3ys.jpg" 
    alt="ä¾èµ–å…³ç³»" 
     /></p>
<p>ä¸Šé¢æ˜¯è®¾è®¡çš„ç›¸å…³ä¾èµ–å…³ç³»å›¾ï¼Œ<code>session</code>æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç»“æ„ä½“ï¼Œ
<code>GlobalManager</code>æ˜¯æ•´ä½“çš„ä¼šè¯ç®¡ç†å™¨è´Ÿè´£æ•°æ®æŒä¹…åŒ–ï¼Œè¿‡æœŸä¼šè¯åƒåœ¾å›æ”¶å·¥ä½œâ™»ï¸ï¼Œ<code>storage</code>æ˜¯å­˜å‚¨å™¨æ¥å£ï¼Œå› ä¸ºæˆ‘ä»¬è¦å®ç°ä¸¤ç§æ–¹å¼å­˜å‚¨ä¼šè¯æ•°æ®æˆ–è€…ä»¥åè¦å¢åŠ å…¶ä»–æŒä¹…åŒ–å­˜å‚¨ï¼Œæ‰€ä»¥å¿…é¡»éœ€è¦æ¥å£æŠ½è±¡æ”¯æŒï¼Œ<code>memory</code>å’Œ<code>redis</code>æ˜¯å­˜å‚¨çš„å…·ä½“å®ç°ã€‚</p>
<ol start="2">
<li><code>storage</code>æ¥å£</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">sessionx</span>

<span class="c1">// session storage interface
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">storage</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Read</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Create</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Update</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">Remove</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>storage</code>å°±9è¡Œä»£ç ï¼Œæ˜¯å…·ä½“çš„ä¼šè¯æ•°æ®æ“ä½œåŠ¨ä½œçš„æŠ½è±¡ï¼Œå…¨éƒ¨å‚æ•°ä½¿ç”¨çš„æ˜¯<code>session</code>è¿™ä¸ªç»“æ„çš„æŒ‡é’ˆï¼Œå¦‚æœå¤„ç†å¼‚å¸¸äº†å°±<code>å³é”™å³è¿”å›</code>ã€‚</p>
<p>ä¸ºä»€ä¹ˆæŠŠå‡½æ•°ç­¾åçš„<code>å½¢å‚</code>ä½¿ç”¨æŒ‡é’ˆç±»å‹çš„ï¼Œè¿™ä¸ªæˆ‘æƒ³çœ‹çš„æ‡‚äººåº”è¯¥çŸ¥é“è¿™æ˜¯ä¸ºä»€ä¹ˆäº†ğŸ˜</p>
<ol start="3">
<li><code>memoryStore</code>ç»“æ„ä½“</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">memoryStore</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>memoryStore</code>ç»“æ„ä½“é‡Œé¢å°±åµŒå…¥<code>sync.Map</code>ç»“æ„ä½“ï¼Œä¸€å¼€å§‹æ˜¯ä½¿ç”¨çš„<code>map</code>è¿™ç§ï¼Œä½†æ˜¯åé¢å‘ç°åœ¨å¹¶å‘è¯»å†™ç„¶ååŠ <code>sync.Mutex</code>é”ğŸ”ï¼Œæ€§èƒ½è¿˜ä¸å¦‚ç›´æ¥ä½¿ç”¨<code>sync.Map</code>é€Ÿåº¦å¿«ã€‚<code>sync.Map</code>ç”¨æ¥åš<code>K:V</code>å­˜å‚¨çš„ï¼Œä¹Ÿå°±æ˜¯<code>sessionid</code>å¯¹åº”<code>session data</code>çš„ã€‚</p>
<p>å®ç°<code>storage</code>å…·ä½“æ–¹æ³•å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">memoryStore</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">ele</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
      <span class="c1">// bug è¿™ä¸ªä¸èƒ½ç›´æ¥ s = ele 
</span><span class="c1"></span>      <span class="nx">s</span><span class="p">.</span><span class="nx">Data</span> <span class="p">=</span> <span class="nx">ele</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">Data</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="c1">// s = nil
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;id `%s` not exist session data&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯»å–æ•°æ®çš„æ—¶å€™å…ˆå°†æŒä¹…åŒ–çš„æ•°æ®è¯»å‡ºæ¥ç„¶åèµ‹å€¼ç»™æœ¬æ¬¡ä¼šè¯çš„<code>session</code>ã€‚</p>
<p><strong>æ³¨æ„:</strong> åœ¨goçš„<code>map</code>ä¸­çš„<code>struct</code>ä¸­çš„å­—æ®µä¸èƒ½å¤Ÿç›´æ¥å¯»å€ï¼Œå®˜æ–¹<strong>issue</strong> <a href="https://github.com/golang/go/issues/3117">https://github.com/golang/go/issues/3117</a></p>
<p>å…¶ä»–å‡ ä¸ªå‡½æ•°:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">memoryStore</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="nx">m</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">memoryStore</span><span class="p">)</span> <span class="nf">Remove</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="nx">m</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">memoryStore</span><span class="p">)</span> <span class="nf">Update</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">ele</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="c1">// ä¸ºä»€ä¹ˆæ˜¯äº¤æ¢data å› ä¸ºæˆ‘ä»¬ä¸ç¡®å®šä¸Šå±‚æ˜¯å¦æ‰©å®¹æ¢äº†åœ°å€
</span><span class="c1"></span>        <span class="nx">ele</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">Data</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Data</span>
        <span class="nx">ele</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Expires</span>
        <span class="c1">//m.sessions[s.ID] = ele
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">nil</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;id `%s` updated session fail&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™å¥è¯ä»£ç æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œå†™è¿‡<code>go</code>éƒ½èƒ½çœ‹å¾—æ‡‚ã€‚</p>
<p>åƒåœ¾å›æ”¶:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">memoryStore</span><span class="p">)</span> <span class="nf">gc</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// recycle your trash every 10 minutes
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="nx">m</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">bool</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">Expires</span><span class="p">.</span><span class="nf">UnixNano</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">m</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">})</span>
        <span class="nx">runtime</span><span class="p">.</span><span class="nf">GC</span><span class="p">()</span>
        <span class="c1">// log.Println(&#34;gc running...&#34;)
</span><span class="c1"></span>    <span class="p">}</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¯”è¾ƒä¼šè¯è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸå°±åˆ é™¤ä¼šè¯ï¼Œä»¥ä¸Šå°±æ˜¯å†…å­˜å­˜å‚¨çš„å®ç°ã€‚</p>
<ol start="4">
<li><code>redisStore</code>ç»“æ„ä½“</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">redisStore</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">sessions</span> <span class="o">*</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Client</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">redisStore</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">sid</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%s&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">RedisKeyPrefix</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
    <span class="nx">bytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sid</span><span class="p">).</span><span class="nf">Bytes</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">Expire</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sid</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">TimeOut</span><span class="p">).</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">decoder</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// log.Println(&#34;redis read:&#34;, s)
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">redisStore</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">setValue</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">redisStore</span><span class="p">)</span> <span class="nf">Update</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">setValue</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">redisStore</span><span class="p">)</span> <span class="nf">Remove</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%s&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">RedisKeyPrefix</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">)).</span><span class="nf">Err</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">redisStore</span><span class="p">)</span> <span class="nf">setValue</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">bytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">encoder</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%s&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">RedisKeyPrefix</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">),</span> <span class="nx">bytes</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">TimeOut</span><span class="p">).</span><span class="nf">Err</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»£ç ä¹Ÿå°±50è¡Œå·¦å³ï¼Œå¾ˆç®€å•å°±æ˜¯é€šè¿‡<code>redis</code>å®¢æˆ·ç«¯å¯¹æ•°æ®è¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒæŠŠæœ¬åœ°çš„ä¼šè¯æ•°æ®æä¾›<code>encoding/gob</code>åºåˆ—åŒ–æˆäºŒè¿›åˆ¶å†™åˆ°<code>redis</code>æœåŠ¡å™¨ä¸Šå­˜å‚¨ï¼Œéœ€è¦çš„æ—¶å€™å†ååºåˆ—åŒ–å‡ºæ¥ã€‚</p>
<p><strong>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¼šæœ‰äººé—®äº†ï¼Œredisæ²¡æœ‰å¹¶å‘é—®é¢˜å—ï¼Ÿ</strong></p>
<p>ğŸ‘¨â€ğŸ’»â€ï¼š é‚£æˆ‘è‚¯å®šä¼šå›ç­”ï¼Œä½ åœ¨é—®è¿™ä¸ªé—®é¢˜ä¹‹å‰æˆ‘ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰äº†è§£è¿‡<code>redis</code>ï¼Ÿï¼Ÿï¼Ÿ</p>
<p><code>Redis</code> å¹¶å‘ç«äº‰æŒ‡çš„æ˜¯å¤šä¸ª <code>Redis</code> å®¢æˆ·ç«¯åŒæ—¶ <code>set key </code>å¼•èµ·çš„å¹¶å‘é—®é¢˜ï¼Œ<code>Redis</code> æ˜¯ä¸€ç§å•çº¿ç¨‹æœºåˆ¶çš„ <code>NoSQL</code> æ•°æ®åº“ï¼Œæ‰€ä»¥ <code>Redis</code> æœ¬èº«å¹¶æ²¡æœ‰é”çš„æ¦‚å¿µã€‚</p>
<p>ä½†æ˜¯å¤šå®¢æˆ·ç«¯åŒæ—¶å¹¶å‘å†™åŒä¸€ä¸ª <code>key</code>ï¼Œä¸€ä¸ª <code>key</code> çš„å€¼æ˜¯ <code>1</code>ï¼Œæœ¬æ¥æŒ‰é¡ºåºä¿®æ”¹ä¸º <code>2,3,4</code> ï¼Œæœ€å <code>key</code> å€¼æ˜¯ <code>4</code>ï¼Œä½†æ˜¯å› ä¸ºå¹¶å‘å»å†™ <code>key</code>ï¼Œé¡ºåºå¯èƒ½å°±å˜æˆäº† <code>4,3,2</code>ï¼Œæœ€å <code>key</code> å€¼å°±å˜æˆäº† <code>2</code>ã€‚</p>
<p>æˆ‘è¿™ä¸ªåº“å½“å‰ä¹Ÿå°±ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¦‚æœä½ éƒ¨ç½²åˆ°å¤šä¸ªæœºå­ï¼Œé‚£å°±ä½¿ç”¨ <code>setnx(key, value)</code> æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œæˆ‘å½“å‰å†™çš„è¿™ä¸ªåº“æ²¡æœ‰æä¾›åˆ†å¸ƒå¼é”ï¼Œå…·ä½“è¯·è‡ªè¡Œ<code>google</code>ã€‚</p>
<ol start="5">
<li><code>manager</code>ç»“æ„ä½“</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">storeType</span> <span class="kt">uint8</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="c1">// memoryStore store type
</span><span class="c1"></span>    <span class="nx">M</span> <span class="nx">storeType</span> <span class="p">=</span> <span class="kc">iota</span>
    <span class="c1">// redis store type
</span><span class="c1"></span>    <span class="nx">R</span>
    <span class="nx">SessionKey</span> <span class="p">=</span> <span class="s">&#34;session-id&#34;</span>
<span class="p">)</span>

<span class="c1">// manager for session manager
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">manager</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">cfg</span>   <span class="o">*</span><span class="nx">Configs</span>
    <span class="nx">store</span> <span class="nx">storage</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">t</span> <span class="nx">storeType</span><span class="p">,</span> <span class="nx">cfg</span> <span class="o">*</span><span class="nx">Configs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">t</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">M</span><span class="p">:</span>
        <span class="c1">// init memory storage
</span><span class="c1"></span>        <span class="nx">m</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">memoryStore</span><span class="p">)</span>
        <span class="k">go</span> <span class="nx">m</span><span class="p">.</span><span class="nf">gc</span><span class="p">()</span>
        <span class="nx">mgr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">manager</span><span class="p">{</span><span class="nx">cfg</span><span class="p">:</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">m</span><span class="p">}</span>
    <span class="k">case</span> <span class="nx">R</span><span class="p">:</span>
        <span class="c1">// parameter verify
</span><span class="c1"></span>        <span class="nx">validate</span> <span class="o">:=</span> <span class="nx">validator</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">validate</span><span class="p">.</span><span class="nf">Struct</span><span class="p">(</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
        <span class="p">}</span>

        <span class="c1">// init redis storage
</span><span class="c1"></span>        <span class="nx">r</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">redisStore</span><span class="p">)</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">sessions</span> <span class="p">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
            <span class="nx">Addr</span><span class="p">:</span>     <span class="nx">cfg</span><span class="p">.</span><span class="nx">RedisAddr</span><span class="p">,</span>
            <span class="nx">Password</span><span class="p">:</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">RedisPassword</span><span class="p">,</span> <span class="c1">// no password set
</span><span class="c1"></span>            <span class="nx">DB</span><span class="p">:</span>       <span class="nx">cfg</span><span class="p">.</span><span class="nx">RedisDB</span><span class="p">,</span>       <span class="c1">// use default DB
</span><span class="c1"></span>            <span class="nx">PoolSize</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">PoolSize</span><span class="p">),</span> <span class="c1">// connection pool size
</span><span class="c1"></span>        <span class="p">})</span>

        <span class="c1">// test connection
</span><span class="c1"></span>        <span class="nx">timeout</span><span class="p">,</span> <span class="nx">cancelFunc</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">8</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="k">defer</span> <span class="nf">cancelFunc</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">timeout</span><span class="p">).</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="nx">mgr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">manager</span><span class="p">{</span><span class="nx">cfg</span><span class="p">:</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">r</span><span class="p">}</span>

    <span class="k">default</span><span class="p">:</span>
      <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;not implement store type&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>manager</code>ç»“æ„ä½“ä¹Ÿå°±ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªå­˜æ”¾æˆ‘ä»¬å…¨å±€é…ç½®ä¿¡æ¯ï¼Œä¸€ä¸ªæˆ‘ä»¬å®ä¾‹åŒ–ä¸åŒçš„æŒä¹…åŒ–å­˜å‚¨çš„å­˜å‚¨å™¨ï¼Œå…¶ä»–ä»£ç å°±æ˜¯è¾…åŠ©æ€§çš„ä»£ç ï¼Œä¸ç»†è¯´äº†ã€‚</p>
<ol start="6">
<li><code>Session</code>ç»“æ„ä½“</li>
</ol>
<p>è¿™ä¸ªç»“æ„ä½“æ˜¯å¯¹åº”ç€æµè§ˆå™¨ä¼šè¯çš„ç»“æ„ä½“ï¼Œè®¾è®¡åŸåˆ™æ˜¯ä¸€ä¸ª<code>id</code>å¯¹åº”ä¸€ä¸ª<code>session</code>ç»“æ„ä½“ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Session</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// ä¼šè¯ID
</span><span class="c1"></span>    <span class="nx">ID</span> <span class="kt">string</span>
    <span class="c1">// sessionè¶…æ—¶æ—¶é—´
</span><span class="c1"></span>    <span class="nx">Expires</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
    <span class="c1">// å­˜å‚¨æ•°æ®çš„map
</span><span class="c1"></span>    <span class="nx">Data</span> <span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">_w</span>   <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
    <span class="c1">// æ¯ä¸ªsessionå¯¹åº”ä¸€ä¸ªcookie
</span><span class="c1"></span>    <span class="nx">Cookie</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Cookie</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å…·ä½“æ“ä½œå‡½æ•°:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Get Retrieves the stored element data from the session via the key
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">s</span><span class="p">.</span><span class="nf">refreshCookie</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">ele</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ele</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;key &#39;%s&#39; does not exist&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Set Stores information in the session
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="nf">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="nx">lock</span><span class="p">[</span><span class="s">&#34;W&#34;</span><span class="p">](</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">s</span><span class="p">.</span><span class="nx">Data</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">Data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
    <span class="p">})</span>

	  <span class="nx">s</span><span class="p">.</span><span class="nf">refreshCookie</span><span class="p">()</span>
	  <span class="k">return</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Remove an element stored in the session
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="nf">Remove</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	  <span class="nx">s</span><span class="p">.</span><span class="nf">refreshCookie</span><span class="p">()</span>

    <span class="nx">lock</span><span class="p">[</span><span class="s">&#34;R&#34;</span><span class="p">](</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="p">})</span>

	  <span class="k">return</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Clean up all data for this session
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="nf">Clean</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nf">refreshCookie</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// åˆ·æ–°cookie ä¼šè¯åªè¦æœ‰æ“ä½œå°±é‡ç½®ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="nf">refreshCookie</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">TimeOut</span><span class="p">)</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Expires</span>
    <span class="c1">// è¿™é‡Œä¸æ˜¯ä½¿ç”¨æŒ‡é’ˆ
</span><span class="c1"></span>    <span class="c1">// å› ä¸ºè¿™é‡Œæˆ‘ä»¬æ”¯æŒredis å¦‚æœwebæœåŠ¡å™¨é‡å¯äº†
</span><span class="c1"></span>    <span class="c1">// é‚£ä¹ˆsessionæ•°æ®åœ¨å†…å­˜é‡Œæ¸…ç©º
</span><span class="c1"></span>    <span class="c1">// ä»redisè¯»å–çš„æ•°æ®ååºåˆ—åŒ–åœ°å€å’Œé‡æ–°å¯åŠ¨çš„ä¸ä¸€æ ·
</span><span class="c1"></span>    <span class="c1">// æ‰€æœ‰ç›´æ¥æ•°æ®æ‹·è´
</span><span class="c1"></span>    <span class="nx">http</span><span class="p">.</span><span class="nf">SetCookie</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">_w</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢æ˜¯å‡ ä¸ªå‡½æ•°æ˜¯ï¼Œä¼šè¯çš„æ•°æ®æ“ä½œå‡½æ•°ï¼Œ<code>refreshCookie()</code>æ˜¯ç”¨æ¥åˆ·æ–°æµè§ˆå™¨<code>cookie</code>ä¿¡æ¯çš„ï¼Œå› ä¸ºæˆ‘åœ¨è®¾è®¡çš„æ—¶å€™åªæœ‰æµè§ˆå™¨æœ‰å¿ƒè·³ä¹Ÿå°±æ˜¯æœ‰æ“ä½œæ•°æ®çš„æ—¶å€™ï¼Œç®¡ç†å™¨å°±é»˜è®¤ä¸ºè¿™ä¸ªæµè§ˆå™¨ä¼šè¯è¿˜æ˜¯æ´»ç€çš„ï¼Œä¼šè‡ªåŠ¨åŒæ­¥æ›´æ–°<code>cookie</code>è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªæ›´æ–°è¿‡ç¨‹å¯ä¸æ˜¯å…‰åˆ·æ–°<code>cookie</code>å°±å®Œäº‹çš„äº†ï¼ŒæŒä¹…åŒ–çš„è¯çš„æ•°æ®è¿‡æœŸæ—¶é—´ä¹Ÿä¸€æ ·æ›´æ–°äº†ã€‚</p>
<p><strong>Handleræ–¹æ³•</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Handler Get session data from the Request
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Handler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="o">*</span><span class="nx">Session</span> <span class="p">{</span>
    <span class="c1">// ä»è¯·æ±‚é‡Œé¢å–session
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">session</span> <span class="nx">Session</span>
    <span class="nx">session</span><span class="p">.</span><span class="nx">_w</span> <span class="p">=</span> <span class="nx">w</span>
    <span class="nx">cookie</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Cookie</span><span class="p">(</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">cookie</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">createSession</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">session</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// IDé€šè¿‡ç¼–ç ä¹‹åé•¿åº¦æ˜¯73ä½
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">73</span> <span class="p">{</span>
        <span class="nx">session</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">Value</span>
        <span class="k">if</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">session</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">createSession</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">session</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">// é˜²æ­¢webæœåŠ¡å™¨é‡å¯ä¹‹åredisä¼šè¯æ•°æ®è¿˜åœ¨
</span><span class="c1"></span>        <span class="c1">// ä½†æ˜¯æµè§ˆå™¨cookieæ²¡æœ‰æ›´æ–°
</span><span class="c1"></span>        <span class="c1">// é‡æ–°åˆ·æ–°cookie
</span><span class="c1"></span>
        <span class="c1">// å­˜åœ¨æŒ‡é’ˆä¸€è‡´é—®é¢˜ï¼Œè¿™æ ·æ“ä½œè¿˜æ˜¯ä¸€å—å†…å­˜ï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦å¤åˆ¶å‰¯æœ¬
</span><span class="c1"></span>        <span class="nx">_</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nb">copy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">)</span>
        <span class="nx">session</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Value</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">ID</span>
        <span class="nx">session</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">Expires</span>
        <span class="nx">http</span><span class="p">.</span><span class="nf">SetCookie</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">)</span>
	    <span class="p">}</span>
      <span class="c1">// åœ°å€ä¸€æ ·ä¸è¡Œï¼ï¼ï¼
</span><span class="c1"></span>      <span class="c1">// log.Printf(&#34;mgr.cfg.Cookie pointer:%p \n&#34;, mgr.cfg.Cookie)
</span><span class="c1"></span>      <span class="c1">// log.Printf(&#34;session.cookie pointer:%p \n&#34;, session.Cookie)
</span><span class="c1"></span>      <span class="k">return</span> <span class="o">&amp;</span><span class="nx">session</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">createSession</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">cookie</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">,</span> <span class="nx">session</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="o">*</span><span class="nx">Session</span> <span class="p">{</span>
      <span class="c1">// init session parameter
</span><span class="c1"></span>      <span class="nx">session</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nf">generateUUID</span><span class="p">()</span>
      <span class="nx">session</span><span class="p">.</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">TimeOut</span><span class="p">)</span>
      <span class="nx">_</span> <span class="p">=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span>

      <span class="c1">// é‡ç½®é…ç½®cookieæ¨¡æ¿
</span><span class="c1"></span>      <span class="nx">session</span><span class="p">.</span><span class="nb">copy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">)</span>
      <span class="nx">session</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Value</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">ID</span>
      <span class="nx">session</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">Expires</span>

      <span class="nx">http</span><span class="p">.</span><span class="nf">SetCookie</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">session</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Handler</code>å‡½æ•°æ˜¯ä»<code>http</code>è¯·æ±‚é‡Œé¢è¯»å–åˆ°<code>sessionid</code>ç„¶åä»æŒä¹…åŒ–å±‚è¯»å–æ•°æ®ç„¶åå®ä¾‹åŒ–ä¸€ä¸ª<code>session</code>ç»“æ„ä½“çš„å‡½æ•°ï¼Œæ²¡æœ‰å•¥å¥½è¯´çš„ï¼Œæ³¨é‡Šå†™ä¸Šé¢äº†ã€‚</p>
<h2 id="å®‰å…¨é˜²å¾¡é—®é¢˜">
    <a href="#%e5%ae%89%e5%85%a8%e9%98%b2%e5%be%a1%e9%97%ae%e9%a2%98" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    å®‰å…¨é˜²å¾¡é—®é¢˜
</h2>
<p>é¦–å…ˆæˆ‘è¿˜æ˜¯é‚£å¥è¯ï¼š<code>ä¸æ‡‚æ”»å‡»ï¼Œæ€ä¹ˆåšé˜²å®ˆ</code>ã€‚
é‚£æˆ‘ä»¬å…ˆè¯´è¯´è¿™ä¸ªé—®é¢˜æ€ä¹ˆäº§ç”Ÿçš„:</p>
<blockquote>
<p><code>ä¸­é—´äººæ”»å‡»</code>ï¼ˆ<code>Man-in-the-MiddleAttack</code>ï¼Œç®€ç§°<code>MITMæ”»å‡»</code>ï¼‰æ˜¯ä¸€ç§<code>é—´æ¥</code>çš„å…¥ä¾µæ”»å‡»ï¼Œè¿™ç§æ”»å‡»æ¨¡å¼æ˜¯é€šè¿‡å„ç§æŠ€æœ¯æ‰‹æ®µå°†å—å…¥ä¾µè€…æ§åˆ¶çš„ä¸€å°è®¡ç®—æœºè™šæ‹Ÿæ”¾ç½®åœ¨ç½‘ç»œè¿æ¥ä¸­çš„ä¸¤å°é€šä¿¡è®¡ç®—æœºä¹‹é—´ï¼Œè¿™å°è®¡ç®—æœºå°±ç§°ä¸º<code>ä¸­é—´äºº</code>ã€‚</p>
</blockquote>
<p>è¿™ä¸ªè¿‡ç¨‹ï¼Œæ­£å¸¸ç”¨æˆ·åœ¨é€šè¿‡æµè§ˆå™¨è®¿é—®æˆ‘ä»¬ç¼–å†™çš„ç½‘ç«™ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æœ‰ä¸ª<code>hack</code>é€šè¿‡<code>arp</code>æ¬ºéª—ï¼ŒæŠŠè·¯ç”±å™¨çš„æµé‡åŠ«æŒåˆ°ä»–çš„ç”µè„‘ä¸Šï¼Œç„¶åé»‘å®¢é€šè¿‡ä¸€äº›ç‰¹æ®Šçš„è½¯ä»¶æŠ“åŒ…ä½ çš„ç½‘ç»œè¯·æ±‚æµé‡ä¿¡æ¯ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœä½ <code>sessionid</code>å¦‚æœå­˜æ”¾åœ¨<code>cookie</code>ä¸­ï¼Œå¾ˆæœ‰å¯èƒ½è¢«é»‘å®¢æå–å¤„ç†ï¼Œå¦‚æœä½ è¿™ä¸ªæ—¶å€™ç™»å½•äº†ç½‘ç«™ï¼Œè¿™æ˜¯é»‘å®¢å°±æ‹¿åˆ°ä½ çš„ç™»å½•å‡­è¯ï¼Œç„¶ååœ¨ç™»å½•è¿›è¡Œ<code>é‡æ”¾</code>ä¹Ÿå°±æ˜¯ä½¿ç”¨ä½ çš„<code>sessionid</code>ï¼Œä»è€Œè¾¾åˆ°è®¿é—®ä½ è´¦æˆ·ç›¸å…³çš„æ•°æ®ç›®çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">)</span> <span class="nf">MigrateSession</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// è¿ç§»åˆ°æ–°å†…å­˜ é˜²æ­¢ä¼šè¯ä¸€è‡´å¼•å‘å®‰å…¨é—®é¢˜
</span><span class="c1"></span>    <span class="c1">// è¿™ä¸ªé—®é¢˜çš„æ ¹æºåœ¨ sessionid ä¸å˜ï¼Œå¦‚æœç”¨æˆ·åœ¨æœªç™»å½•æ—¶æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ª sessionidï¼Œç™»å½•ä¹‹åæœåŠ¡ç«¯ç»™ç”¨æˆ·é‡æ–°æ¢ä¸€ä¸ª sessionidï¼Œå°±å¯ä»¥é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»äº†ã€‚
</span><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nf">generateUUID</span><span class="p">()</span>
    <span class="nx">newSession</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">deepcopy</span><span class="p">.</span><span class="nf">Anything</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;migrate session make a deep copy from src into dst failed&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">newSession</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">ID</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span>
    <span class="nx">newSession</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">Value</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ID</span>
    <span class="nx">newSession</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">Expires</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">mgr</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">TimeOut</span><span class="p">)</span>
    <span class="nx">newSession</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nx">_w</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">_w</span>
    <span class="nx">newSession</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">).</span><span class="nf">refreshCookie</span><span class="p">()</span>
    <span class="c1">// æ–°å†…å­˜å¼€å§‹æŒä¹…åŒ–
</span><span class="c1"></span>    <span class="c1">// log.Printf(&#34;old session pointer:%p \n&#34;, s)
</span><span class="c1"></span>    <span class="c1">// log.Printf(&#34;new session pointer:%p \n&#34;, newSession.(*Session))
</span><span class="c1"></span>    <span class="c1">//log.Println(&#34;MigrateSession:&#34;, newSession.(*Session))
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">newSession</span><span class="p">.(</span><span class="o">*</span><span class="nx">Session</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœå¤§å®¶å†™è¿‡<code>Java</code>è¯­è¨€ï¼Œéƒ½åº”è¯¥ä½¿ç”¨è¿‡<code>springboot</code>è¿™ä¸ªæ¡†æ¶ï¼Œå¦‚æœä½ çœ‹è¿‡æºä»£ç ï¼Œé‚£å°±çŸ¥é“è¿™ä¸ªæ¡†æ¶é‡Œé¢çš„<code>session</code>å®‰å…¨ç­–ç•¥æœ‰ä¸€ä¸ª<code>migrateSession</code>é€‰é¡¹ï¼Œè¡¨ç¤ºåœ¨ç™»å½•æˆåŠŸä¹‹åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œç„¶åè®²æ—§çš„ <code>session</code> ä¸­çš„ä¿¡æ¯å¤åˆ¶åˆ°æ–°çš„ <code>session</code> ä¸­ã€‚</p>
<p>æˆ‘å‚ç…§ä»–çš„ç­–ç•¥ï¼Œä¹ŸåŒæ ·åœ¨æˆ‘è¿™ä¸ªåº“é‡Œé¢å®ç°äº†ï¼Œåœ¨ç”¨æˆ·åŒ¿åè®¿é—®çš„æ—¶å€™æ˜¯ä¸€ä¸ª <code>sessionid</code>ï¼Œå½“ç”¨æˆ·æˆåŠŸç™»å½•ä¹‹åï¼Œåˆæ˜¯å¦å¤–ä¸€ä¸ª <code>sessionid</code>ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆé¿å…ä¼šè¯å›ºå®šæ”»å‡»ã€‚</p>
<p>ä½¿ç”¨çš„æ—¶å€™ä¹Ÿå¯ä»¥<code>éšæ—¶ä½¿ç”¨é€šè¿‡MigrateSessionè¿›è¡Œè°ƒç”¨</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸€ä½†è¢«è°ƒç”¨ï¼ŒåŸå§‹æ•°æ®å’Œ<code>id</code>å…¨éƒ¨è¢«åˆ·æ–°äº†ï¼Œå†…å­˜åœ°å€ä¹Ÿæ¢äº†ï¼Œå¯ä»¥çœ‹æˆ‘çš„æºä»£ç ã€‚</p>
<h2 id="ä½¿ç”¨æ¼”ç¤º">
    <a href="#%e4%bd%bf%e7%94%a8%e6%bc%94%e7%a4%ba" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    ä½¿ç”¨æ¼”ç¤º
</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;net/http&#34;</span>
    <span class="s">&#34;time&#34;</span>

    <span class="nx">sessionx</span> <span class="s">&#34;github.com/higker/sesssionx&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="c1">// é…ç½®ä¿¡æ¯
</span><span class="c1"></span>    <span class="nx">cfg</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">sessionx</span><span class="p">.</span><span class="nx">Configs</span><span class="p">{</span>
          <span class="nx">TimeOut</span><span class="p">:</span>        <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
          <span class="nx">RedisAddr</span><span class="p">:</span>      <span class="s">&#34;127.0.0.1:6379&#34;</span><span class="p">,</span>
          <span class="nx">RedisDB</span><span class="p">:</span>        <span class="mi">0</span><span class="p">,</span>
          <span class="nx">RedisPassword</span><span class="p">:</span>  <span class="s">&#34;redis.nosql&#34;</span><span class="p">,</span>
          <span class="nx">RedisKeyPrefix</span><span class="p">:</span> <span class="nx">sessionx</span><span class="p">.</span><span class="nx">SessionKey</span><span class="p">,</span>
          <span class="nx">PoolSize</span><span class="p">:</span>       <span class="mi">100</span><span class="p">,</span>
          <span class="nx">Cookie</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">{</span>
            <span class="nx">Name</span><span class="p">:</span>     <span class="nx">sessionx</span><span class="p">.</span><span class="nx">SessionKey</span><span class="p">,</span>
            <span class="nx">Path</span><span class="p">:</span>     <span class="s">&#34;/&#34;</span><span class="p">,</span>
            <span class="nx">Expires</span><span class="p">:</span>  <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span> <span class="c1">// TimeOut
</span><span class="c1"></span>            <span class="nx">Secure</span><span class="p">:</span>   <span class="kc">false</span><span class="p">,</span>
            <span class="nx">HttpOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Rè¡¨ç¤ºrediså­˜å‚¨ cfgæ˜¯é…ç½®ä¿¡æ¯
</span><span class="c1"></span>	  <span class="nx">sessionx</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">sessionx</span><span class="p">.</span><span class="nx">R</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">)</span>

    <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/set&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">session</span> <span class="o">:=</span> <span class="nx">sessionx</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
        <span class="nx">session</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;K&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006 01-02 15:04:05&#34;</span><span class="p">))</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="s">&#34;set time value succeed.&#34;</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/get&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">session</span> <span class="o">:=</span> <span class="nx">sessionx</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
        <span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;K&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;The stored value is : %s&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">))</span>
    <span class="p">})</span>

    <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/migrate&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">session</span> <span class="o">:=</span> <span class="nx">sessionx</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">MigrateSession</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">writer</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">_</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="https://tva1.sinaimg.cn/large/008eGmZEgy1goyv71f8qdj30a106sdg9.jpg" 
    alt="å¥åº·æ£€æµ‹" 
     /></p>
<p><img loading="lazy" 
    src="https://tva1.sinaimg.cn/large/008eGmZEgy1goyv89devcj312a0f6jt5.jpg" 
    alt="å¤šé¡¹é›†æˆåŒ–æµ‹è¯•" 
     /></p>
<h2 id="å°-ç»“">
    <a href="#%e5%b0%8f-%e7%bb%93" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    å° ç»“
</h2>
<p>æ¨èè¿˜æ˜¯ä½¿ç”¨<code>JWT</code>è¿™ç§æ–¹å¼åšé‰´æƒï¼Œä¸è¿‡ä¹Ÿæœ‰ä¸€ä½“åŒ–<code>webåº”ç”¨</code>çš„<code>session</code>ä¹Ÿä¸ä¼šè¢«è¿™ä¹ˆæ—©æ·˜æ±°ï¼Œå¦‚æœä¸Šé¢æœ‰é—®é¢˜ï¼Œæ¬¢è¿å¤§ä½¬ä»¬<code>pr</code>ï¼Œè¿˜æœ‰éƒ¨åˆ†ä»£ç æ²¡æœ‰åˆ—å‡ºï¼Œå¯ä»¥å»ä»“åº“çœ‹çœ‹ã€‚</p>
<h2 id="ç›¸å…³é“¾æ¥">
    <a href="#%e7%9b%b8%e5%85%b3%e9%93%be%e6%8e%a5" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    ç›¸å…³é“¾æ¥
</h2>
<p>ä»£ç ä»“åº“ï¼š<a href="https://github.com/auula/sessionx">https://github.com/auula/sessionx</a></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/redis-distributed-lock/" title="Previous post (older)">
            <span>Previous</span>
            Redis Distributed Lock
            </a>
        
        
        
        <a rel="next" href="/post/web-safe-csrf/" title="Next post (newer)">
            <span>Next</span>
            Web Safe Csrf
            </a> 
        
    </nav>
    
</div>
 
<div class="container">
    
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-hugo-tania-netlify-app" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (DISQUS) {
            DISQUS.reset({
                reload: true
            })
        }
    })
</script>

</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    <script defer src="/ts/features.b5555d1ae12309fd7a67c0d19ce81e7098647818f6758eb95f88ea9d550d2d2c.js" data-enable-footnotes="true"></script>
</footer>
    </body>
</html>