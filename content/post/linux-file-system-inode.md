---
title: "Linux File System Inode"
date: 2021-12-26T22:18:31+08:00
---

## 文件系统

现在计算机数据存储功能是必不可少的，大家的图片和视频都是数据，但是这些数据是怎么保存在硬盘上的呢？我不知道大家有没有想过？存储介质分类有很多种，例如：机械硬盘、固态硬盘、闪存...这些都是物理存储介质，怎么让数据保存在里面？不丢失？那么多数据又是怎么在组织起来管理的呢？这时就要说说`文件系统`了。

![传统宏内核系统架构](https://tva1.sinaimg.cn/large/008i3skNgy1gxqgs7d3svj30qq0z2jus.jpg)


`文件系统`就是操作系统给我们抽象一种`中间层`让我们和物理磁盘可以打交道，文件系统就是负责把用户的文件存到磁盘硬件中，因为即使计算机断电了，磁盘里的数据并不会丢失，所以可以持久化的保存文件。

## 怎么工作的？

`文件系统`怎么工作的？无论底层存储介质是磁盘还是`SSD`，都被该层抽象为` Block` 的概念。文件系统在初始化时，会先在挂载的块存储上的第一个位置创建一个 `Super Block`，文件在抽象之前，每个文件是有元数据信息的，例如：文件名字、文件大小、创建时间、访问时间、归属者、所在组等...构成元数据信息，好比现实中一本书，书的各种信息。


`Linux` 最经典的一句话是：`一切皆文件!`，不仅普通的文件和目录，就连块设备、管道、`socket` 等，也都是统一交给文件系统管理的，但是这些信息要怎么组织到磁盘上，而且文件可能随着时间推移大小也随着变化，文件可能被拷贝到不同物理介质上，这就给文件系统设计者带来一个大问题？


![Mac/Unix](https://tva1.sinaimg.cn/large/008i3skNgy1gxqhgwkqzgj31mk0u0gwh.jpg)

文件系统会把底层存储的物理硬盘设备，抽象成单单固定大小的块，块区，那这么多快和分区要怎么组织去管理？后面出现了一种基于`inode 索引节点`的文件组织管理方式。


## 文件组织管理方式

![Sector](https://tva1.sinaimg.cn/large/008i3skNgy1gxri322130j30o60c4t9f.jpg)

硬件磁盘会被划分成固定大小块，存储块大小可能是`512字节`的`sector`然后8个组成一个`4KB`的块，这个看具体划分方式了，文件也是对应的这么划分存储的，这么设计的时候那就可以把每个块加上唯一编号，也可以看成文件的`名字`，然后把块建立一个索引，但是大部分存储文件的都是以`mb`作为单位的，例如：一部电影可能有`4GB`大小，这就给快存储设计带来设计挑战，一个`4GB`的电影就需要`100`万个`4kb`的块，但是每个块上还有一个唯一的文件名称或者编号，需要占用`8`字节的空间，这么一搞那么就需要另外的`8mb`记录，又带了来这样的问题？

![一个4gb的电影可能有很多个4kb的块组成](https://files.mdnice.com/user/8699/5d7255ac-cabb-4a1d-93cb-80198ddf280d.png)

有了这些问题，文件系统设计者引入一个叫`index node`的数据结构，文件数据被存储不同块里面，文件的元数据信息就会被存储在`inode`里面。

![Linux 中的文件元数据](https://tva1.sinaimg.cn/large/008i3skNgy1gxric8yj52j31ew0e042e.jpg)

`inode`会被存储在`inode table`里面的，`inode`也就是`inode table`里面条目，`inode table` 包含该文件系统中所有文件的列表，`inode table` 中的各个 `inode` 项具有唯一的编号。

![inode table](https://tva1.sinaimg.cn/large/008i3skNgy1gxrir6neurj30ku066q3i.jpg)

`inode table`记录这个`inode number`对应文件所对应的`metadata`，如上图所示👆🏻，这样我们就方便管理文件元数据了，每个 `inode` 都有一个号码，操作系统用 `inode` 号码来识别不同的文件，这里值得重复一遍，`Unix/Linux` 系统内部不使用文件名，而使用 `inode` 号码来识别文件。对于系统来说，文件名只是 `inode` 号码便于识别的别称一样。

![linux 下查看文件对应的inode number](https://tva1.sinaimg.cn/large/008i3skNgy1gxrju656f5j30yg048jru.jpg)

我们在系统调用的时候，发生了什么？实际上，系统内部将这个过程分成三步：

- 系统找到文件名对应的 `inode number` 
- 通过 `inode number`，获取 `inode` 信息
- 根据 `inode` 信息，找到文件数据所在的 `block`，读写数据。



## inode 怎么工作的？
通过上面的了解，得知了每个文件都对应一个`inode`，然后管理文件的时候把所有文件块存储在`inode`里面但是这种不是没有问题的，随着时间文件不断加大，`inode`就要在创建的时候就预留足够好的空间，才能保证后面文件的各种变化，例如我未来存储文件是`4GB`，我现在就要去把`inode`占用大小设置为`8mb`显然这个不能充分发挥磁盘利用率。如果`inode`分配小了，未来文件变大了，`inode`不够用，各种问题。。。

![随着时间变化](https://tva1.sinaimg.cn/large/008i3skNgy1gxrjnpcqhuj311p0u0jsj.jpg)

`Linux`系统为了解决这个问题，引入和虚拟内存的那种概念，把`inode`通过采用分级的方式来组织存储块号，`inode`为了解决数据变化问题，它引入了`3个存储指针设计`。

![结构体](https://tva1.sinaimg.cn/large/008i3skNgy1gxrk9tfvhhj314d0u0q5h.jpg)

`inode`中保存了`3`种指针，`inode`有`12`个直接指针，间接指针有`3`，二级指针就`1`个，可以存储设备的块号，第一个指针为直接指针可以直接指向数据块本身，数据块就是保存数据的块，第二针指针是`间接指针`，`间接指针`是在前面的指针指针不够的时候才会启用，`间接指针`可以看成链表那样，`间接指针`会指向一个一个级索引块，这块本身又是一个数据块的指针也是只是指向存储数据块，第`3`类指针，指向一个二级索引块，二级索引块的指针还可以指向新的索引块，这样一来就可以动态划分`INODE`了。


## 小结

很多看完说这个有什么用？如果不做系统底层的开发的话，如果你这么想，我只是觉得你很肤浅！😒，看完`inode`的设计马上就可以联想到一个分布式文件系统雏形，有时候要懂得变通的。例如`Google 的GFS`系统，当然据我所知`gfs`已经没有使用了，取代`gfs`是一个款新的叫`Colossus`系统，这个系统目前设计细节没有公开，但是我看到有`cmu`的朋友说`Google Infra Team`的`Larry Greenfield`的一个`Lecture`其中介绍了`Larry`对`GFS`的设计初衷理念、优劣势、瓶颈、改进，然后研发了现役系统`Colossus (GFS2)`系统，当然操作系统的文件系统设计细节远远不止本文所讲的`inode`，但是`inode`对组织管理文件起到了很大作用，希望读读者有帮助吧，我也是个人笔记分享。



